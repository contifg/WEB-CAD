<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Web‑CAD Ligero (estilo AutoCAD) — Demo</title>
  <style>
    :root{--bg:#0f1720;--panel:#0b1220;--accent:#1f6feb;--muted:#9aa9bf}
    html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Arial;background:var(--bg);color:#e6eef8}
    #app{display:grid;grid-template-columns:56px 1fr;grid-template-rows:48px 1fr 120px;height:100vh;gap:8px}
    header{grid-column:1/-1;display:flex;align-items:center;padding:6px 12px;background:linear-gradient(90deg,#071022, #0c1728)}
    .logo{font-weight:700;margin-right:8px}
    nav.toolbar{grid-row:2;display:flex;flex-direction:column;gap:6px;padding:8px;background:var(--panel);box-shadow:inset 0 0 0 1px rgba(255,255,255,0.02)}
    .tool{width:40px;height:40px;border-radius:6px;display:flex;align-items:center;justify-content:center;background:transparent;border:1px solid transparent;cursor:pointer}
    .tool:hover{background:rgba(255,255,255,0.03)}
    .tool.active{background:var(--accent)}
    main.canvas{position:relative;background:linear-gradient(180deg,#071021,#021021);overflow:hidden}
    #viewport{position:absolute;inset:0}
    .topbar{position:absolute;left:80px;top:8px;background:rgba(2,6,12,0.6);padding:6px 10px;border-radius:6px}
    .status{position:absolute;right:8px;top:8px;background:rgba(2,6,12,0.6);padding:6px 10px;border-radius:6px;color:var(--muted)}
    footer.commandline{grid-column:1/-1;background:#071021;border-top:1px solid rgba(255,255,255,0.03);display:flex;gap:8px;align-items:center;padding:12px}
    .cmd{flex:1;background:#031023;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.02)}
    .cmd input{width:100%;background:transparent;border:0;color:#dfefff;outline:none}
    .panel-params{position:absolute;right:8px;top:64px;background:rgba(2,6,12,0.9);padding:10px;border-radius:8px;min-width:220px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input[type=number],select{width:100%;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.03);background:#071127;color:#e6eef8}
    button.primary{margin-top:8px;width:100%;padding:8px;border-radius:6px;border:0;background:var(--accent);color:white;cursor:pointer}
    a.link{color:var(--accent);text-decoration:none}
    .help{font-size:12px;color:var(--muted);margin-top:6px}
  </style>
</head>
<body>
  <div id="app">
    <header>
      <div class="logo">Web‑CAD Ligero</div>
      <div style="opacity:.7;font-size:13px">Mini‑CAD en navegador — crear sólidos básicos + herramientas</div>
    </header>

    <nav class="toolbar" title="Herramientas">
      <button class="tool" id="tool_select" title="Seleccionar">S</button>
      <button class="tool" id="tool_move" title="Mover">M</button>
      <button class="tool" id="tool_cube" title="Cubo / Caja">□</button>
      <button class="tool" id="tool_sphere" title="Esfera">◯</button>
      <button class="tool" id="tool_cylinder" title="Cilindro">◎</button>
      <button class="tool" id="tool_semisphere" title="Semiesfera">◐</button>
      <button class="tool" id="tool_triangle" title="Prisma triangular">△</button>
      <button class="tool" id="tool_undo" title="Deshacer">↺</button>
      <button class="tool" id="tool_redo" title="Rehacer">↻</button>
      <button class="tool" id="tool_export" title="Exportar GLTF/OBJ">⇪</button>
    </nav>

    <main class="canvas">
      <div class="topbar">Modo: <span id="modeLabel">Seleccionar</span></div>
      <div class="status">Click en la cuadrícula para colocar</div>
      <div id="viewport"></div>

      <div class="panel-params">
        <label>Parámetros</label>
        <label>Escala / Tamaño (unidad)</label>
        <input id="param_size" type="number" value="1" step="0.1">
        <label>Altura / Profundidad</label>
        <input id="param_height" type="number" value="1" step="0.1">
        <label><input id="snapToggle" type="checkbox"> Snap a grid</label>
        <button id="btn_delete" class="primary">Borrar seleccionado</button>
        <div class="help">Comandos: "cube 2", "sphere 1.5", "cylinder 1 2" → escribe en la línea de comandos</div>
      </div>

    </main>

    <footer class="commandline">
      <div class="cmd"><input id="cmdInput" placeholder="Comando (ej: cube 2)" autocomplete="off"></div>
      <button id="runCmd" class="primary">Ejecutar</button>
    </footer>
  </div>

  <script src="https://unpkg.com/three@0.154.0/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.154.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://unpkg.com/three@0.154.0/examples/js/controls/TransformControls.js"></script>
  <script src="https://unpkg.com/three@0.154.0/examples/js/exporters/GLTFExporter.js"></script>
  <script>
    // Basic scene
    const viewport = document.getElementById('viewport');
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x04121a);
    const camera = new THREE.PerspectiveCamera(60, 1, 0.1, 1000);
    camera.position.set(8, 8, 8);
    const renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setPixelRatio(window.devicePixelRatio);
    viewport.appendChild(renderer.domElement);

    // Controls
    const orbit = new THREE.OrbitControls(camera, renderer.domElement);
    orbit.enableDamping = true;

    // Grid and ground
    const grid = new THREE.GridHelper(200, 200, 0x2a3b4a, 0x182530);
    grid.material.opacity = 0.8; grid.material.transparent = true;
    scene.add(grid);
    const planeGeo = new THREE.PlaneGeometry(200,200);
    const planeMat = new THREE.MeshBasicMaterial({visible:false});
    const ground = new THREE.Mesh(planeGeo, planeMat);
    ground.rotateX(-Math.PI/2);
    scene.add(ground);

    // Light
    const dir = new THREE.DirectionalLight(0xffffff,0.9); dir.position.set(5,10,7); scene.add(dir);
    scene.add(new THREE.AmbientLight(0xffffff,0.3));

    // Resize
    function onResize(){
      const r = viewport.clientWidth / viewport.clientHeight;
      camera.aspect = r; camera.updateProjectionMatrix();
      renderer.setSize(viewport.clientWidth, viewport.clientHeight);
    }
    window.addEventListener('resize', onResize);

    // Raycaster for placement
    const ray = new THREE.Raycaster();
    const mouse = new THREE.Vector2();

    // Scene objects and history
    const objects = [];
    const undoStack = [];
    const redoStack = [];

    // Transform controls
    const transform = new THREE.TransformControls(camera, renderer.domElement);
    transform.addEventListener('dragging-changed', function(e){ orbit.enabled = !e.value; });
    scene.add(transform);

    // Helpers
    function pushHistory(action){ undoStack.push(action); if(undoStack.length>200) undoStack.shift(); redoStack.length=0; }
    function doUndo(){ const a = undoStack.pop(); if(!a) return; if(a.type==='add'){ scene.remove(a.obj); removeObj(a.obj); redoStack.push(a); } else if(a.type==='remove'){ scene.add(a.obj); objects.push(a.obj); redoStack.push(a); } }
    function doRedo(){ const a = redoStack.pop(); if(!a) return; if(a.type==='add'){ scene.add(a.obj); objects.push(a.obj); undoStack.push(a); } else if(a.type==='remove'){ scene.remove(a.obj); removeObj(a.obj); undoStack.push(a); } }
    function removeObj(o){ const i = objects.indexOf(o); if(i>=0) objects.splice(i,1); }

    // Primitive creation
    function createMesh(type, size=1, height=1){
      let geo;
      switch(type){
        case 'cube': geo = new THREE.BoxGeometry(size, height, size); break;
        case 'sphere': geo = new THREE.SphereGeometry(size, 32, 24); break;
        case 'cylinder': geo = new THREE.CylinderGeometry(size, size, height, 32); break;
        case 'semisphere': geo = new THREE.SphereGeometry(size, 32, 24, 0, Math.PI*2, 0, Math.PI/2); break;
        case 'triangle': {
          // triangular prism
          const shape = new THREE.Shape(); shape.moveTo(0,0); shape.lineTo(size,0); shape.lineTo(size/2, Math.sqrt(3)/2 * size); shape.lineTo(0,0);
          const extrude = new THREE.ExtrudeGeometry(shape, {depth: height, bevelEnabled:false}); geo = extrude; break; }
        default: geo = new THREE.BoxGeometry(size,size,size);
      }
      const mat = new THREE.MeshStandardMaterial({color:0x7fb3ff, metalness:0.2, roughness:0.6});
      const mesh = new THREE.Mesh(geo, mat);
      mesh.userData.type = type;
      return mesh;
    }

    // UI state
    let currentTool = 'select';
    let placing = null; // type when placing
    const modeLabel = document.getElementById('modeLabel');
    function setTool(t){ currentTool=t; document.querySelectorAll('.tool').forEach(b=>b.classList.remove('active')); const btn = document.getElementById('tool_'+t); if(btn) btn.classList.add('active'); modeLabel.textContent = t.charAt(0).toUpperCase()+t.slice(1); }

    // Attach tool buttons
    document.getElementById('tool_select').onclick = ()=>{ setTool('select'); placing=null; transform.detach(); }
    document.getElementById('tool_move').onclick = ()=>{ setTool('translate'); transform.setMode('translate'); }
    document.getElementById('tool_cube').onclick = ()=>{ setTool('place'); placing='cube'; }
    document.getElementById('tool_sphere').onclick = ()=>{ setTool('place'); placing='sphere'; }
    document.getElementById('tool_cylinder').onclick = ()=>{ setTool('place'); placing='cylinder'; }
    document.getElementById('tool_semisphere').onclick = ()=>{ setTool('place'); placing='semisphere'; }
    document.getElementById('tool_triangle').onclick = ()=>{ setTool('place'); placing='triangle'; }
    document.getElementById('tool_undo').onclick = ()=>{ doUndo(); }
    document.getElementById('tool_redo').onclick = ()=>{ doRedo(); }

    // Delete selected
    document.getElementById('btn_delete').onclick = ()=>{ if(transform.object){ const o = transform.object; scene.remove(o); pushHistory({type:'remove', obj:o}); transform.detach(); } }

    // Export
    document.getElementById('tool_export').onclick = ()=>{
      const exporter = new THREE.GLTFExporter();
      exporter.parse(scene, function(result){
        const output = JSON.stringify(result);
        const blob = new Blob([output], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'scene.gltf'; a.click();
      }, {binary:false});
    }

    // Canvas click: place or select
    renderer.domElement.addEventListener('pointerdown', function(ev){
      if(window.getSelection) window.getSelection().removeAllRanges();
      const rect = renderer.domElement.getBoundingClientRect();
      mouse.x = ((ev.clientX - rect.left) / rect.width) * 2 - 1;
      mouse.y = -((ev.clientY - rect.top) / rect.height) * 2 + 1;
      ray.setFromCamera(mouse, camera);
      const intersects = ray.intersectObject(ground);
      if(intersects.length>0){
        const p = intersects[0].point.clone();
        // snap
        if(document.getElementById('snapToggle').checked){ p.x = Math.round(p.x); p.y = Math.round(p.y); p.z = Math.round(p.z); }
        if(placing){
          const size = parseFloat(document.getElementById('param_size').value) || 1;
          const height = parseFloat(document.getElementById('param_height').value) || size;
          const m = createMesh(placing, size, height);
          m.position.copy(p); m.position.y += height/2; scene.add(m); objects.push(m); pushHistory({type:'add', obj:m});
        } else {
          // selection: pick nearest object
          const picks = ray.intersectObjects(objects, true);
          if(picks.length>0){ transform.attach(picks[0].object); }
          else transform.detach();
        }
      }
    });

    // Command line
    document.getElementById('runCmd').onclick = runCommand;
    document.getElementById('cmdInput').addEventListener('keydown', function(e){ if(e.key==='Enter') runCommand(); });
    function runCommand(){ const txt = document.getElementById('cmdInput').value.trim(); if(!txt) return; const parts = txt.split(/\s+/); const cmd = parts[0].toLowerCase(); if(cmd==='cube' || cmd==='box'){ const s = parseFloat(parts[1])||1; const h = parseFloat(parts[2])||s; const m = createMesh('cube', s, h); m.position.set(0,h/2,0); scene.add(m); objects.push(m); pushHistory({type:'add', obj:m}); }
      else if(cmd==='sphere'){ const r = parseFloat(parts[1])||1; const m = createMesh('sphere', r); m.position.set(0,r,0); scene.add(m); objects.push(m); pushHistory({type:'add', obj:m}); }
      else if(cmd==='cylinder'){ const r = parseFloat(parts[1])||1; const h = parseFloat(parts[2])||2; const m = createMesh('cylinder', r, h); m.position.set(0,h/2,0); scene.add(m); objects.push(m); pushHistory({type:'add', obj:m}); }
      else if(cmd==='semisphere'){ const r = parseFloat(parts[1])||1; const m = createMesh('semisphere', r); m.position.set(0,r/2,0); scene.add(m); objects.push(m); pushHistory({type:'add', obj:m}); }
      else if(cmd==='triangle'){ const s = parseFloat(parts[1])||1; const h = parseFloat(parts[2])||1; const m = createMesh('triangle', s, h); m.position.set(0,h/2,0); scene.add(m); objects.push(m); pushHistory({type:'add', obj:m}); }
      else if(cmd==='help'){ alert('Comandos: cube|box [size] [height]\nsphere [r]\ncylinder [r] [h]\nsemisphere [r]\ntriangle [base] [depth]'); }
      else{ alert('Comando no reconocido. Escribe "help".'); }
      document.getElementById('cmdInput').value='';
    }

    // Animation loop
    function animate(){ requestAnimationFrame(animate); orbit.update(); renderer.render(scene,camera); }
    animate();
    onResize();

    // Initial welcome object
    const welcome = createMesh('cube',1,1); welcome.position.set(0,0.5,0); scene.add(welcome); objects.push(welcome);

  </script>
</body>
</html>
